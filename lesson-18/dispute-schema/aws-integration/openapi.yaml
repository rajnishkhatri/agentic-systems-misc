openapi: 3.0.3
info:
  title: Dispute Management API
  description: |
    REST API for managing payment disputes (chargebacks) across multiple card networks.

    ## Authentication
    All endpoints require Bearer token authentication via AWS Cognito.

    ## Rate Limiting
    - 1000 requests per minute per API key
    - Webhook endpoints: 10,000 requests per minute

    ## Idempotency
    POST requests support idempotency via the `Idempotency-Key` header.
  version: 1.0.0
  contact:
    name: Dispute Management Team
    email: disputes@example.com
  license:
    name: Proprietary

servers:
  - url: https://api.disputes.example.com/v1
    description: Production
  - url: https://api.disputes-staging.example.com/v1
    description: Staging
  - url: https://api.disputes-dev.example.com/v1
    description: Development

tags:
  - name: Disputes
    description: Core dispute operations
  - name: Evidence
    description: Evidence submission and management
  - name: Webhooks
    description: Network webhook endpoints

security:
  - bearerAuth: []

paths:
  /disputes:
    get:
      tags: [Disputes]
      operationId: listDisputes
      summary: List all disputes
      description: Returns a paginated list of disputes filtered by the provided parameters.
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/startingAfter'
        - $ref: '#/components/parameters/endingBefore'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/DisputeStatus'
        - name: reason
          in: query
          schema:
            $ref: '#/components/schemas/DisputeReason'
        - name: charge
          in: query
          description: Filter by charge ID
          schema:
            type: string
            pattern: ^ch_[a-zA-Z0-9]{24}$
        - name: payment_intent
          in: query
          description: Filter by payment intent ID
          schema:
            type: string
            pattern: ^pi_[a-zA-Z0-9]{24}$
        - name: created[gte]
          in: query
          description: Filter disputes created at or after this timestamp
          schema:
            type: integer
            format: unix-timestamp
        - name: created[lte]
          in: query
          description: Filter disputes created at or before this timestamp
          schema:
            type: integer
            format: unix-timestamp
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DisputeList'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:dispute-list/invocations

    post:
      tags: [Disputes]
      operationId: createDispute
      summary: Create a dispute (internal/test only)
      description: |
        Creates a new dispute. In production, disputes are created via network webhooks.
        This endpoint is primarily for testing and internal use.
      parameters:
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisputeCreateRequest'
      responses:
        '201':
          description: Dispute created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dispute'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Dispute already exists for this charge
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:dispute-intake/invocations

  /disputes/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Dispute ID
        schema:
          type: string
          pattern: ^dp_[a-zA-Z0-9]{24}$

    get:
      tags: [Disputes]
      operationId: getDispute
      summary: Retrieve a dispute
      description: Retrieves the dispute with the given ID.
      parameters:
        - name: expand[]
          in: query
          description: Related objects to expand in the response
          schema:
            type: array
            items:
              type: string
              enum: [evidence, balance_transactions, enhanced_evidence]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dispute'
        '404':
          $ref: '#/components/responses/NotFound'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:dispute-get/invocations

    patch:
      tags: [Disputes]
      operationId: updateDispute
      summary: Update a dispute
      description: |
        Updates the dispute with the provided parameters.
        Set `submit: true` to submit evidence to the card network.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisputeUpdateRequest'
      responses:
        '200':
          description: Dispute updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dispute'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Dispute cannot be updated (already resolved or under review)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:dispute-update/invocations

  /disputes/{id}/evidence:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          pattern: ^dp_[a-zA-Z0-9]{24}$

    post:
      tags: [Evidence]
      operationId: submitEvidence
      summary: Submit evidence for a dispute
      description: |
        Submits evidence for the dispute. Evidence can include text fields and file references.

        ## Limits
        - Total text evidence: 150,000 characters
        - Total file evidence: 4.5 MB
        - Mastercard disputes: Maximum 19 pages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EvidenceSubmitRequest'
      responses:
        '200':
          description: Evidence submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dispute'
        '400':
          description: Invalid evidence or limits exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Evidence deadline has passed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:evidence-submit/invocations

  /disputes/{id}/evidence/upload-url:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          pattern: ^dp_[a-zA-Z0-9]{24}$

    post:
      tags: [Evidence]
      operationId: getEvidenceUploadUrl
      summary: Get a pre-signed URL for evidence upload
      description: |
        Returns a pre-signed S3 URL for uploading evidence files.
        The URL expires in 15 minutes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename, content_type, field_name]
              properties:
                filename:
                  type: string
                  description: Name of the file
                  example: receipt.pdf
                content_type:
                  type: string
                  description: MIME type of the file
                  enum:
                    - application/pdf
                    - image/jpeg
                    - image/png
                    - image/gif
                    - application/msword
                    - application/vnd.openxmlformats-officedocument.wordprocessingml.document
                field_name:
                  type: string
                  description: Evidence field this file is for
                  enum:
                    - receipt
                    - refund_policy
                    - cancellation_policy
                    - customer_communication
                    - customer_signature
                    - shipping_documentation
                    - service_documentation
                    - duplicate_charge_documentation
                    - uncategorized_file
                file_size_bytes:
                  type: integer
                  description: File size in bytes (for validation)
                  maximum: 4500000
      responses:
        '200':
          description: Upload URL generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  upload_url:
                    type: string
                    format: uri
                    description: Pre-signed S3 URL for upload
                  file_id:
                    type: string
                    pattern: ^file_[a-zA-Z0-9]{24}$
                    description: File ID to use when submitting evidence
                  expires_at:
                    type: string
                    format: date-time
                    description: URL expiration time
                  max_file_size_bytes:
                    type: integer
                    description: Maximum allowed file size
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:evidence-upload-url/invocations

  /disputes/{id}/close:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          pattern: ^dp_[a-zA-Z0-9]{24}$

    post:
      tags: [Disputes]
      operationId: closeDispute
      summary: Close a dispute (accept loss)
      description: |
        Closes the dispute by accepting the chargeback.
        The dispute status will be set to `lost`.

        **This action cannot be undone.**
      responses:
        '200':
          description: Dispute closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dispute'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Dispute already resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:dispute-close/invocations

  /webhooks/visa:
    post:
      tags: [Webhooks]
      operationId: visaWebhook
      summary: Visa network webhook
      description: Receives chargeback notifications from Visa VROL
      security: []
      parameters:
        - name: X-Visa-Signature
          in: header
          required: true
          schema:
            type: string
        - name: X-Visa-Timestamp
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VisaWebhookPayload'
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
        '401':
          description: Invalid signature
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:webhook-visa/invocations

  /webhooks/mastercard:
    post:
      tags: [Webhooks]
      operationId: mastercardWebhook
      summary: Mastercard network webhook
      description: Receives chargeback notifications from Mastercom
      security: []
      parameters:
        - name: X-Mastercard-Signature
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MastercardWebhookPayload'
      responses:
        '200':
          description: Webhook processed
        '401':
          description: Invalid signature
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:webhook-mastercard/invocations

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      x-amazon-apigateway-authtype: cognito_user_pools
      x-amazon-apigateway-authorizer:
        type: cognito_user_pools
        providerARNs:
          - arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}

  parameters:
    limit:
      name: limit
      in: query
      description: Maximum number of items to return (1-100)
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10

    startingAfter:
      name: starting_after
      in: query
      description: Cursor for pagination (dispute ID)
      schema:
        type: string
        pattern: ^dp_[a-zA-Z0-9]{24}$

    endingBefore:
      name: ending_before
      in: query
      description: Cursor for reverse pagination (dispute ID)
      schema:
        type: string
        pattern: ^dp_[a-zA-Z0-9]{24}$

    idempotencyKey:
      name: Idempotency-Key
      in: header
      description: Unique key for idempotent requests
      schema:
        type: string
        maxLength: 255

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Dispute:
      type: object
      required: [id, object, amount, currency, status, reason, created]
      properties:
        id:
          type: string
          pattern: ^dp_[a-zA-Z0-9]{24}$
          example: dp_1NxQkL2eZvKYlo2CXr5EPQmR
        object:
          type: string
          enum: [dispute]
        amount:
          type: integer
          description: Disputed amount in smallest currency unit
          example: 15000
        currency:
          type: string
          pattern: ^[a-z]{3}$
          example: usd
        status:
          $ref: '#/components/schemas/DisputeStatus'
        reason:
          $ref: '#/components/schemas/DisputeReason'
        created:
          type: integer
          format: unix-timestamp
        charge:
          type: string
          pattern: ^ch_[a-zA-Z0-9]{24}$
        payment_intent:
          type: string
          pattern: ^pi_[a-zA-Z0-9]{24}$
        transaction_amount:
          type: integer
        transaction_date:
          type: integer
          format: unix-timestamp
        is_charge_refundable:
          type: boolean
        livemode:
          type: boolean
        network_reason_code:
          type: string
        metadata:
          type: object
          additionalProperties:
            type: string
        evidence:
          $ref: '#/components/schemas/Evidence'
        evidence_details:
          $ref: '#/components/schemas/EvidenceDetails'
        payment_method_details:
          $ref: '#/components/schemas/PaymentMethodDetails'
        balance_transactions:
          type: array
          items:
            $ref: '#/components/schemas/BalanceTransaction'

    DisputeStatus:
      type: string
      enum:
        - needs_response
        - under_review
        - won
        - lost
        - warning_needs_response
        - warning_under_review
        - warning_closed
        - charge_refunded

    DisputeReason:
      type: string
      enum:
        - credit_not_processed
        - duplicate
        - fraudulent
        - general
        - product_not_received
        - product_unacceptable
        - subscription_canceled
        - unrecognized

    Evidence:
      type: object
      properties:
        access_activity_log:
          type: string
          maxLength: 20000
        billing_address:
          type: string
          maxLength: 5000
        cancellation_policy:
          type: string
          description: File ID
        cancellation_policy_disclosure:
          type: string
          maxLength: 20000
        cancellation_rebuttal:
          type: string
          maxLength: 20000
        customer_communication:
          type: string
          description: File ID
        customer_email_address:
          type: string
          format: email
          maxLength: 254
        customer_name:
          type: string
          maxLength: 500
        customer_purchase_ip:
          type: string
          format: ipv4
        customer_signature:
          type: string
          description: File ID
        duplicate_charge_documentation:
          type: string
          description: File ID
        duplicate_charge_explanation:
          type: string
          maxLength: 20000
        duplicate_charge_id:
          type: string
        product_description:
          type: string
          maxLength: 20000
        receipt:
          type: string
          description: File ID
        refund_policy:
          type: string
          description: File ID
        refund_policy_disclosure:
          type: string
          maxLength: 20000
        refund_refusal_explanation:
          type: string
          maxLength: 20000
        service_date:
          type: string
          maxLength: 500
        service_documentation:
          type: string
          description: File ID
        shipping_address:
          type: string
          maxLength: 5000
        shipping_carrier:
          type: string
          maxLength: 500
        shipping_date:
          type: string
          maxLength: 500
        shipping_documentation:
          type: string
          description: File ID
        shipping_tracking_number:
          type: string
          maxLength: 500
        uncategorized_file:
          type: string
          description: File ID
        uncategorized_text:
          type: string
          maxLength: 20000

    EvidenceDetails:
      type: object
      properties:
        due_by:
          type: integer
          format: unix-timestamp
          nullable: true
        has_evidence:
          type: boolean
        past_due:
          type: boolean
        submission_count:
          type: integer
        enhanced_eligibility:
          type: object
          properties:
            visa_compelling_evidence_3:
              type: object
              properties:
                status:
                  type: string
                  enum: [qualified, requires_action, not_qualified]
                required_actions:
                  type: array
                  items:
                    type: string

    PaymentMethodDetails:
      type: object
      properties:
        type:
          type: string
          enum: [card, paypal, klarna, affirm, afterpay, bank_transfer, ach_debit]
        card:
          type: object
          properties:
            brand:
              type: string
              enum: [visa, mastercard, amex, discover, diners, jcb, unionpay]
            case_type:
              type: string
              enum: [chargeback, inquiry, pre_arbitration, arbitration, compliance]
            network_reason_code:
              type: string
            last4:
              type: string
              pattern: ^[0-9]{4}$
            funding:
              type: string
              enum: [credit, debit, prepaid, unknown]

    BalanceTransaction:
      type: object
      properties:
        id:
          type: string
          pattern: ^txn_[a-zA-Z0-9]{24}$
        amount:
          type: integer
        currency:
          type: string
        type:
          type: string
          enum: [dispute, dispute_reversal, dispute_fee, dispute_fee_refund]
        created:
          type: integer
          format: unix-timestamp
        fee:
          type: integer
        net:
          type: integer

    DisputeList:
      type: object
      properties:
        object:
          type: string
          enum: [list]
        data:
          type: array
          items:
            $ref: '#/components/schemas/Dispute'
        has_more:
          type: boolean
        url:
          type: string
          format: uri

    DisputeCreateRequest:
      type: object
      required: [charge, amount, currency, reason]
      properties:
        charge:
          type: string
          pattern: ^ch_[a-zA-Z0-9]{24}$
        amount:
          type: integer
          minimum: 1
        currency:
          type: string
          pattern: ^[a-z]{3}$
        reason:
          $ref: '#/components/schemas/DisputeReason'
        network_reason_code:
          type: string
        metadata:
          type: object
          additionalProperties:
            type: string
            maxLength: 500
          maxProperties: 50

    DisputeUpdateRequest:
      type: object
      properties:
        metadata:
          type: object
          additionalProperties:
            type: string
        evidence:
          $ref: '#/components/schemas/Evidence'
        submit:
          type: boolean
          description: Set to true to submit evidence to the network

    EvidenceSubmitRequest:
      type: object
      properties:
        evidence:
          $ref: '#/components/schemas/Evidence'
        enhanced_evidence:
          type: object
          properties:
            visa_compelling_evidence_3:
              type: object
              properties:
                disputed_transaction:
                  type: object
                prior_undisputed_transactions:
                  type: array
                  items:
                    type: object
                  minItems: 2
                  maxItems: 5
        submit:
          type: boolean
          default: false

    VisaWebhookPayload:
      type: object
      properties:
        messageType:
          type: string
        caseNumber:
          type: string
        acquirerReferenceNumber:
          type: string
        amount:
          type: number
        currency:
          type: string
        reasonCode:
          type: string
        cardNumber:
          type: string
          description: Masked PAN

    MastercardWebhookPayload:
      type: object
      properties:
        caseId:
          type: string
        caseType:
          type: string
        amount:
          type: number
        currencyCode:
          type: string
        reasonCode:
          type: string
        acquirerRefNumber:
          type: string

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [type, message]
          properties:
            type:
              type: string
              enum:
                - invalid_request_error
                - authentication_error
                - rate_limit_error
                - api_error
            message:
              type: string
            code:
              type: string
            param:
              type: string
            doc_url:
              type: string
              format: uri

x-amazon-apigateway-request-validators:
  all:
    validateRequestBody: true
    validateRequestParameters: true
  params-only:
    validateRequestBody: false
    validateRequestParameters: true

x-amazon-apigateway-gateway-responses:
  DEFAULT_4XX:
    responseTemplates:
      application/json: '{"error": {"type": "invalid_request_error", "message": "$context.error.messageString"}}'
  DEFAULT_5XX:
    responseTemplates:
      application/json: '{"error": {"type": "api_error", "message": "An internal error occurred"}}'
  UNAUTHORIZED:
    statusCode: 401
    responseTemplates:
      application/json: '{"error": {"type": "authentication_error", "message": "Invalid or missing authentication token"}}'
  QUOTA_EXCEEDED:
    statusCode: 429
    responseParameters:
      gatewayresponse.header.Retry-After: "'60'"
    responseTemplates:
      application/json: '{"error": {"type": "rate_limit_error", "message": "Rate limit exceeded"}}'
