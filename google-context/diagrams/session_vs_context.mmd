%%{init: {'flowchart': {'htmlLabels': false}}}%%
graph TB
    subgraph SessionHistory["ðŸ“š Session History (Full Conversation)"]
        SH_Size["50 turns\n50,000 tokens\nStored in Database"]

        subgraph SH_Events["Events Log (Immutable)"]
            E0["Turn 0: 'Help me understand karma yoga'\n(Initial Objective)"]
            E1["Turn 1: User asks about Chapter 3"]
            E2["Turn 2: Agent retrieves verses 3.1-3.5"]
            E3["Turn 3: 'Thanks!'"]
            E5["Turn 5: 'Always use Sivananda translations'\n(Explicit Constraint)"]
            E10["Turn 10-40: Detailed exploration..."]
            E45["Turn 45: User asks about nishkama karma"]
            E50["Turn 50: Agent explains selfless action"]
        end

        E0 --> E1 --> E2 --> E3 --> E5 --> E10 --> E45 --> E50
    end

    subgraph Trigger["âš ï¸ Compression Trigger"]
        T_Check["Token count: 7,600 / 8,000\nThreshold: 95% capacity"]
        T_Decision{Compression\nNeeded?}
    end

    subgraph Compression["ðŸ—œï¸ Compression Process"]
        C1["1. Identify Protected Context"]
        C2["2. Mark Recent Turns (Last 5-10)"]
        C3["3. Summarize Compressible Events"]

        C1 --> C2 --> C3
    end

    subgraph ContextWindow["ðŸŽ¯ Context Window (Curated Subset)"]
        CW_Size["8,000 token limit\nSent to LLM"]

        subgraph CW_Protected["Protected Context (300 tokens)"]
            P0["Turn 0: 'Help me understand karma yoga'"]
            P5["Turn 5: 'Always use Sivananda translations'"]
        end

        subgraph CW_Compressed["Compressed Events (200 tokens)"]
            Comp["Turns 6-44 Summary:\n'User explored karma yoga in Ch 3\nwith focus on selfless action.\nAgent provided Sivananda commentary.'"]
        end

        subgraph CW_Recent["Recent Context (1,500 tokens)"]
            R45["Turn 45: User asks about nishkama karma"]
            R46["Turn 46-49: Discussion..."]
            R50["Turn 50: Agent explains selfless action"]
        end

        subgraph CW_Memory["Retrieved Memories (100 tokens)"]
            M1["User prefers Sivananda commentary"]
            M2["User is beginner level"]
        end

        subgraph CW_RAG["RAG Results (5,900 tokens)"]
            RAG1["Chapter 3, Verses 1-10"]
            RAG2["Sivananda commentary on nishkama karma"]
            RAG3["Related concepts from Ch 2, Ch 5"]
        end
    end

    SessionHistory -->|"Token count check"| Trigger
    Trigger --> T_Decision
    T_Decision -->|"Yes (â‰¥95%)"| Compression
    T_Decision -->|"No (<95%)"| ContextWindow
    Compression --> ContextWindow

    CW_Protected --> CW_Size
    CW_Compressed --> CW_Size
    CW_Recent --> CW_Size
    CW_Memory --> CW_Size
    CW_RAG --> CW_Size

    ContextWindow -->|"Inference"| LLM["ðŸ¤– LLM Generates Response"]

    style SessionHistory fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    style ContextWindow fill:#e8f5e9,stroke:#388e3c,stroke-width:3px
    style Compression fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Trigger fill:#ffebee,stroke:#d32f2f,stroke-width:2px

    style E0 fill:#fff59d,stroke:#f57f17,stroke-width:2px
    style E5 fill:#fff59d,stroke:#f57f17,stroke-width:2px
    style P0 fill:#fff59d,stroke:#f57f17,stroke-width:2px
    style P5 fill:#fff59d,stroke:#f57f17,stroke-width:2px

    style LLM fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px
